

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Tabular Data ETL to NebulaGraph with dbt - siwei.io</title><meta name="Description" content="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt."><meta property="og:url" content="https://siwei.io/en/nebulagraph-etl-dbt/">
  <meta property="og:site_name" content="siwei.io">
  <meta property="og:title" content="Tabular Data ETL to NebulaGraph with dbt">
  <meta property="og:description" content="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-11-23T19:01:45+08:00">
    <meta property="article:modified_time" content="2023-04-28T12:05:20+08:00">
    <meta property="article:tag" content="Nebula Graph">
    <meta property="article:tag" content="Etl">
    <meta property="article:tag" content="Dbt">
    <meta property="article:tag" content="Graph Modeling">
    <meta property="article:tag" content="MovieLens">
    <meta property="article:tag" content="OMDB">
    <meta property="og:image" content="https://siwei.io/nebulagraph-etl-dbt/featured-image.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://siwei.io/nebulagraph-etl-dbt/featured-image.webp"><meta name="twitter:title" content="Tabular Data ETL to NebulaGraph with dbt">
<meta name="twitter:description" content="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt.">
      <meta name="twitter:site" content="@wey_gu">
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><meta name="twitter:creator" content="@wey_gu" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://siwei.io/en/nebulagraph-etl-dbt/" /><link rel="prev" href="https://siwei.io/en/fraud-detection-with-nebulagraph/" /><link rel="next" href="https://siwei.io/en/chatgpt-and-nebulagraph-predict-fifa-world-cup/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript>
    
    
    
    <meta name="baidu-site-verification" content="code-4R67zl7SwH" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Tabular Data ETL to NebulaGraph with dbt",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://siwei.io/en/nebulagraph-etl-dbt/"
        },"image": ["https://siwei.io/images/site-feature-image.webp"],"genre": "posts","keywords": "Nebula Graph, etl, dbt, Graph Modeling, MovieLens, OMDB","wordcount":  3626 ,
        "url": "https://siwei.io/en/nebulagraph-etl-dbt/","datePublished": "2022-11-23T19:01:45+08:00","dateModified": "2023-04-28T12:05:20+08:00","publisher": {
            "@type": "Organization",
            "name": "Wey Gu","logo": "https://siwei.io/images/site-feature-image.webp"},"author": {
                "@type": "Person",
                "name": "Wey Gu"
            },"description": "How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt."
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/en/" title="siwei.io"><span class="header-title-pre"><i class='fas fa-code-branch'></i></span>siwei.io</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/en/about/"> About </a><a class="menu-item" href="/en/projects/"> Project </a><a class="menu-item" href="/en/sketch-notes/"> Sketches </a><a class="menu-item" href="/en/posts/"> Blog </a><a class="menu-item" href="/en/cources/"> Hands-on </a><a class="menu-item" href="/en/talk/"> Talks </a><a class="menu-item" href="https://vesoft.com/en/careers/" rel="noopener noreferrer" target="_blank"> Hire </a><a class="menu-item" href="/en/about/#contact"> Contact </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language"><i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/en/nebulagraph-etl-dbt/" selected></option><option value="/nebulagraph-etl-dbt/"></option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Black</option>
                        <option value="auto">Auto</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/en/" title="siwei.io"><span class="header-title-pre"><i class='fas fa-code-branch'></i></span>siwei.io</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/en/about/" title="">About</a><a class="menu-item" href="/en/projects/" title="">Project</a><a class="menu-item" href="/en/sketch-notes/" title="">Sketches</a><a class="menu-item" href="/en/posts/" title="">Blog</a><a class="menu-item" href="/en/cources/" title="">Hands-on</a><a class="menu-item" href="/en/talk/" title="">Talks</a><a class="menu-item" href="https://vesoft.com/en/careers/" title="" rel="noopener noreferrer" target="_blank">Hire</a><a class="menu-item" href="/en/about/#contact" title="">Contact</a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="black">Black</option>
                    <option value="auto">Auto</option>
                </select>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language"><i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/en/nebulagraph-etl-dbt/" selected></option><option value="/nebulagraph-etl-dbt/"></option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ol>
    <li><a href="#task">Task</a></li>
    <li><a href="#data-analysis">Data Analysis</a></li>
    <li><a href="#graph-modeling">Graph Modeling</a></li>
    <li><a href="#data-transform">Data Transform</a>
      <ol>
        <li><a href="#from-omdb">From OMDB</a></li>
        <li><a href="#from-movielens-dataset">From MovieLens dataset</a></li>
        <li><a href="#graph-modeling-property-graph">Graph Modeling (Property Graph)</a></li>
      </ol>
    </li>
    <li><a href="#tooling">Tooling</a>
      <ol>
        <li><a href="#dbt">dbt</a></li>
        <li><a href="#nebulagraph-data-ingestion">NebulaGraph data ingestion</a></li>
      </ol>
    </li>
    <li><a href="#dbt--nebula-importer-in-actions">dbt + Nebula-Importer in Actions</a>
      <ol>
        <li><a href="#preparing-the-dbt-environment">Preparing the dbt environment</a></li>
        <li><a href="#setup-env-with-dbt">Setup env with dbt</a></li>
        <li><a href="#data-download-and-preprocess">Data download and preprocess</a></li>
        <li><a href="#compose-the-transform-model">Compose the Transform model</a></li>
        <li><a href="#export-data-to-csv">Export data to CSV</a></li>
        <li><a href="#ingest-data-into-nebulagraph">Ingest data into NebulaGraph</a>
          <ol>
            <li><a href="#bootstrap-a-nebulagraph-cluster">Bootstrap a NebulaGraph cluster</a></li>
            <li><a href="#define-the-data-schema">Define the Data Schema</a></li>
            <li><a href="#create-a-nebula-importer-conf-file">Create a Nebula-Importer conf file</a></li>
            <li><a href="#ingesting-the-data">Ingesting the data</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ol>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Tabular Data ETL to NebulaGraph with dbt</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class="author fas fa-user-circle fa-fw"></span><a href="https://siwei.io" title="Author" target="_blank" rel="noopener noreferrer author" class="author">Wey Gu</a>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/en/categories/nebula-graph/"><i class="far fa-folder fa-fw"></i>Nebula Graph</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-11-23">2022-11-23</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-04-28">2023-04-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3626 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;18 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        
        loading="eager"
        src="/nebulagraph-etl-dbt/featured-image.webp"
        srcset="/nebulagraph-etl-dbt/featured-image.webp, /nebulagraph-etl-dbt/featured-image.webp 1.5x, /nebulagraph-etl-dbt/featured-image.webp 2x"
        sizes="auto"
        alt="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt."
        title="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt." height="914"   width="1720" ></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ol>
    <li><a href="#task">Task</a></li>
    <li><a href="#data-analysis">Data Analysis</a></li>
    <li><a href="#graph-modeling">Graph Modeling</a></li>
    <li><a href="#data-transform">Data Transform</a>
      <ol>
        <li><a href="#from-omdb">From OMDB</a></li>
        <li><a href="#from-movielens-dataset">From MovieLens dataset</a></li>
        <li><a href="#graph-modeling-property-graph">Graph Modeling (Property Graph)</a></li>
      </ol>
    </li>
    <li><a href="#tooling">Tooling</a>
      <ol>
        <li><a href="#dbt">dbt</a></li>
        <li><a href="#nebulagraph-data-ingestion">NebulaGraph data ingestion</a></li>
      </ol>
    </li>
    <li><a href="#dbt--nebula-importer-in-actions">dbt + Nebula-Importer in Actions</a>
      <ol>
        <li><a href="#preparing-the-dbt-environment">Preparing the dbt environment</a></li>
        <li><a href="#setup-env-with-dbt">Setup env with dbt</a></li>
        <li><a href="#data-download-and-preprocess">Data download and preprocess</a></li>
        <li><a href="#compose-the-transform-model">Compose the Transform model</a></li>
        <li><a href="#export-data-to-csv">Export data to CSV</a></li>
        <li><a href="#ingest-data-into-nebulagraph">Ingest data into NebulaGraph</a>
          <ol>
            <li><a href="#bootstrap-a-nebulagraph-cluster">Bootstrap a NebulaGraph cluster</a></li>
            <li><a href="#define-the-data-schema">Define the Data Schema</a></li>
            <li><a href="#create-a-nebula-importer-conf-file">Create a Nebula-Importer conf file</a></li>
            <li><a href="#ingesting-the-data">Ingesting the data</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ol>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt.</p>
</blockquote>
<!--

[TOC]

-->
<h2 id="task" class="headerLink">
    <a href="#task" class="header-mark"></a>1 Task</h2><p>Imagine we are building a Knowledge Graph for a content provider web service with NebulaGraph, thus leveraging it to support a Knowledge Base QA system, Recommendation System, and Reasoning system.</p>
<p>The knowledge information persisted in different data sources from some Service APIs, Databases, Data Warehouses, or even some files in S3.</p>
<p>We need to:</p>
<ul>
<li>Analyze data to extract needed knowledge</li>
<li>Model the Graph based on relationships we care</li>
<li>Extract the relationships and ingest them to NebulaGraph</li>
</ul>
<h2 id="data-analysis" class="headerLink">
    <a href="#data-analysis" class="header-mark"></a>2 Data Analysis</h2><p>Assume that we are fetching data from <a href="https://www.omdb.org/en/us/content/Help:DataDownload" target="_blank" rel="noopener noreferrer">OMDB</a> and <a href="https://grouplens.org/datasets/movielens/" target="_blank" rel="noopener noreferrer">MovieLens</a>.</p>
<p>OMDB is an open movie database, we now think of it as one of our services, and we can get the following information.</p>
<ul>
<li>Movies</li>
<li>Classification of movies</li>
<li>The crew in the movie (director, action director, actors, post-production, etc.)</li>
<li>Movie covers, promos, etc.</li>
</ul>
<p>MovieLens is an open dataset, we consider it as the user data of our services, the information we can obtain is:</p>
<ul>
<li>Users</li>
<li>Movies</li>
<li>User interaction on movie ratings</li>
</ul>
<h2 id="graph-modeling" class="headerLink">
    <a href="#graph-modeling" class="header-mark"></a>3 Graph Modeling</h2><p>We were building this Graph for a recommendation system and talked about some basic methods in <a href="siwei.io/recommendation-system-with-graphdb/" rel="">this</a> article, which:</p>
<p>In the Content-Base Filter method(CBF), the relationship of user-&gt; movie, movie-&gt; category, movie-&gt; actor, and movie-&gt; director are concerned.</p>
<p>And the collaborative filtering approach is concerned with the relationship between the user and -&gt; movie.</p>
<p>The recommendation reasoning service is concerned with all the above relationships.</p>
<p>To summarize, we need the following edges:</p>
<ul>
<li>watched(rate(double))</li>
<li>with_genre</li>
<li>directed_by</li>
<li>acted_by</li>
</ul>
<p>Accordingly, the vertex types will be:</p>
<ul>
<li>user(user_id)</li>
<li>movie(name)</li>
<li>person(name, birthdate)</li>
<li>genre(name)</li>
</ul>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/schema_0.webp"
        srcset="/nebulagraph-etl-dbt/schema_0.webp, /nebulagraph-etl-dbt/schema_0.webp 1.5x, /nebulagraph-etl-dbt/schema_0.webp 2x"
        sizes="auto"
        alt="schema_0"
        title="schema_0" height="852"   width="1686" ></figure></p>
<h2 id="data-transform" class="headerLink">
    <a href="#data-transform" class="header-mark"></a>4 Data Transform</h2><p>With the source date finalized, let&rsquo;s see how they could be mapped and transformed into the graph.</p>
<h3 id="from-omdb" class="headerLink">
    <a href="#from-omdb" class="header-mark"></a>4.1 From OMDB</h3><p>First, there is the data in OMDB, which consists of many tables, such as the table <code>all_movies</code>, which stores all the movies and their names in different languages.</p>
<table>
<thead>
<tr>
<th>movie_id</th>
<th>name</th>
<th>language_iso_639_1</th>
<th>official_translation</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Cowboy Bebop</td>
<td>de</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>Cowboy Bebop</td>
<td>en</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>Ariel - Abgebrannt in Helsinki</td>
<td>de</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>Shadows in Paradise</td>
<td>en</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>Im Schatten des Paradieses</td>
<td>de</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>Schatten im Paradies</td>
<td>de</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>And the <code>all_casts</code> table holds all roles in the film industry.</p>
<table>
<thead>
<tr>
<th>movie_id</th>
<th>person_id</th>
<th>job_id</th>
<th>role</th>
<th>position</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>1</td>
<td>21</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>11</td>
<td>1</td>
<td>13</td>
<td></td>
<td>1</td>
</tr>
<tr>
<td>11</td>
<td>2</td>
<td>15</td>
<td>Luke Skywalker</td>
<td>1</td>
</tr>
<tr>
<td>11</td>
<td>3</td>
<td>15</td>
<td>Han Solo</td>
<td>3</td>
</tr>
<tr>
<td>11</td>
<td>4</td>
<td>15</td>
<td>Leia Organa</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>But the name and other information of each person here, as well as the position he/she holds in the film, are in separate tables.</p>
<ul>
<li>
<p><code>job_names</code></p>
<p>For example, 1 stands for writer, and 2 stands for producer. Interestingly, like movie id and name, job_id to name is a one-to-many relationship, because the data in OMDB is multilingual.</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>job_id</th>
<th>name</th>
<th>language_iso_639_1</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Autoren</td>
<td>de</td>
</tr>
<tr>
<td>1</td>
<td>Writing Department</td>
<td>en</td>
</tr>
<tr>
<td>1</td>
<td>Departamento de redacción</td>
<td>es</td>
</tr>
<tr>
<td>1</td>
<td>Département écriture</td>
<td>fr</td>
</tr>
<tr>
<td>1</td>
<td>Scenariusz</td>
<td>pl</td>
</tr>
<tr>
<td>2</td>
<td>Produzenten</td>
<td>de</td>
</tr>
<tr>
<td>2</td>
<td>Production Department</td>
<td>en</td>
</tr>
</tbody>
</table>
<ul>
<li><code>all_people</code></li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>birthday</th>
<th>deathday</th>
<th>gender</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>George Lucas</td>
<td>1944-05-14</td>
<td>\N</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>Mark Hamill</td>
<td>1951-09-25</td>
<td>\N</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>Harrison Ford</td>
<td>1942-07-13</td>
<td>\N</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>Carrie Fisher</td>
<td>1956-10-21</td>
<td>2016-12-27</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>Peter Cushing</td>
<td>1913-05-26</td>
<td>1994-08-11</td>
<td>0</td>
</tr>
<tr>
<td>6</td>
<td>Anthony Daniels</td>
<td>1946-02-21</td>
<td>\N</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>This is a typical case in RDBMS where the data source is a table structure, so for the relationship <code>movie &lt;-[directed_by]-(person)</code>, it involves four tables <code>all_movies</code>, <code>all_casts</code>, <code>all_people</code>, <code>job_names</code>:</p>
<ul>
<li>directed_by
<ul>
<li>Starting from person_id in all_casts</li>
<li>To movie_id in all_casts
<ul>
<li>Where job_id is &ldquo;director&rdquo; in job_names</li>
</ul>
</li>
</ul>
</li>
<li>movie
<ul>
<li>person_id in all_casts</li>
<li>Name from all_movies by id, language is &ldquo;en&rdquo;</li>
</ul>
</li>
<li>person
<ul>
<li>movie_id in all_casts</li>
<li>Name, birthday in all_people</li>
</ul>
</li>
</ul>
<p>Till now, all tables we cared about in OMDB are:</p>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/modeling_omdb.webp"
        srcset="/nebulagraph-etl-dbt/modeling_omdb.webp, /nebulagraph-etl-dbt/modeling_omdb.webp 1.5x, /nebulagraph-etl-dbt/modeling_omdb.webp 2x"
        sizes="auto"
        alt="modeling_omdb"
        title="modeling_omdb" height="1506"   width="2862" ></figure></p>
<h3 id="from-movielens-dataset" class="headerLink">
    <a href="#from-movielens-dataset" class="header-mark"></a>4.2 From MovieLens dataset</h3><p>While the above is just about one data source, in real scenarios, we also need to collect and aggregate data from other sources. For example, now also need to extract knowledge from the MovieLens dataset.</p>
<p>Here, the only relationship we utilize is <code>user -&gt; movie</code>.</p>
<ul>
<li><code>movies.csv</code></li>
</ul>
<table>
<thead>
<tr>
<th>movieId</th>
<th>title</th>
<th>genres</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Toy Story (1995)</td>
<td>Adventure</td>
</tr>
<tr>
<td>2</td>
<td>Jumanji (1995)</td>
<td>Adventure</td>
</tr>
<tr>
<td>3</td>
<td>Grumpier Old Men (1995)</td>
<td>Comedy</td>
</tr>
<tr>
<td>4</td>
<td>Waiting to Exhale (1995)</td>
<td>Comedy</td>
</tr>
</tbody>
</table>
<ul>
<li><code>ratings.csv</code></li>
</ul>
<table>
<thead>
<tr>
<th>userId</th>
<th>movieId</th>
<th>rating</th>
<th>timestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>4</td>
<td>964982703</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>4</td>
<td>964981247</td>
</tr>
<tr>
<td>1</td>
<td>6</td>
<td>4</td>
<td>964982224</td>
</tr>
</tbody>
</table>
<p>From the preview of the data in the two tables, naturally, we need one type of relationship: <code>watched</code> and vertex: <code>user</code>:</p>
<ul>
<li>watched
<ul>
<li>Starting from the userId in <code>ratings.csv</code></li>
<li>To movieId in <code>ratings.csv</code></li>
<li>With rating from rating in <code>ratings.csv</code></li>
</ul>
</li>
<li>user
<ul>
<li>With userId from <code>ratings.csv</code></li>
</ul>
</li>
</ul>
<p>However, you must have noticed that movieId in the MovieLens dataset and movie id in OMDB are two different systems, if we need to associate them, we need to convert movieId in MovieLens to movie id in OMDB, and the condition of association between them is a movie title.</p>
<p>However, by observation, we know that:</p>
<ol>
<li>the titles in OMDB movies are multilingual</li>
<li>the titles in MovieLens have the year information like <code>(1995)</code> at the end of the title</li>
</ol>
<p>So our conclusion is</p>
<ul>
<li>watched
<ul>
<li>Starting from the userId in <code>ratings.csv</code></li>
<li>To movieId in <code>ratings.csv</code>
<ul>
<li>Get the movie title with movieId from <code>movies.csv</code> and find its movie_id from OMDB
<ul>
<li>Where we should match the title in language: English with the suffix of the year being removed</li>
</ul>
</li>
</ul>
</li>
<li>With rating from rating in <code>ratings.csv</code></li>
</ul>
</li>
<li>user
<ul>
<li>With userId from <code>ratings.csv</code></li>
</ul>
</li>
</ul>
<p>Now the modeling puts the two tables like this figure:</p>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/modeling_omdb_movielens.webp"
        srcset="/nebulagraph-etl-dbt/modeling_omdb_movielens.webp, /nebulagraph-etl-dbt/modeling_omdb_movielens.webp 1.5x, /nebulagraph-etl-dbt/modeling_omdb_movielens.webp 2x"
        sizes="auto"
        alt="modeling_omdb_movielens"
        title="modeling_omdb_movielens" height="1008"   width="2212" ></figure></p>
<h3 id="graph-modeling-property-graph" class="headerLink">
    <a href="#graph-modeling-property-graph" class="header-mark"></a>4.3 Graph Modeling (Property Graph)</h3><p>To summarize, we need to aggregate different tables (or CSV files in table form) from multiple data sources, such that the correspondence is shown in the figure: where the blue dashed line indicates the source of data information for the vertices in the graph, and the pink dashed line indicates the source of edge information.</p>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/schema_mapping_to_graph.webp"
        srcset="/nebulagraph-etl-dbt/schema_mapping_to_graph.webp, /nebulagraph-etl-dbt/schema_mapping_to_graph.webp 1.5x, /nebulagraph-etl-dbt/schema_mapping_to_graph.webp 2x"
        sizes="auto"
        alt="schema_mapping_to_graph"
        title="schema_mapping_to_graph" height="1696"   width="1794" ></figure></p>
<p>Then, we have to format the ids of individuals in different tables, for example, user_id, which is a self-incrementing number that we want to convert to a globally unique vertex_id. A convenient way to do this is to add a string prefix to the existing id, such as <code>u_</code>.</p>
<p>Eventually, for the relationship <code>user -[watched]-&gt; movie</code>, we can process the table structure data as follows.</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>rating</th>
<th>title</th>
<th>omdb_movie_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>u_1</td>
<td>5</td>
<td>Seven (a.k.a. Se7en)</td>
<td>807</td>
</tr>
<tr>
<td>u_1</td>
<td>5</td>
<td>Star Wars: Episode IV - A New Hope</td>
<td>11</td>
</tr>
<tr>
<td>u_1</td>
<td>5</td>
<td>Star Wars: Episode IV - A New Hope</td>
<td>10</td>
</tr>
<tr>
<td>u_1</td>
<td>4</td>
<td>Mask, The</td>
<td>832</td>
</tr>
<tr>
<td>u_1</td>
<td>3</td>
<td>Mrs. Doubtfire</td>
<td>832</td>
</tr>
</tbody>
</table>
<p>Where, in each row, three variables exist to construct the graph structure:</p>
<ul>
<li><code>user</code> vertex id</li>
<li><code>movie</code> vertex id</li>
<li>the rating value as the property of the <code>watched</code> edge</li>
</ul>
<h2 id="tooling" class="headerLink">
    <a href="#tooling" class="header-mark"></a>5 Tooling</h2><p>At this point, we have completed the data analysis and graph modeling design, before we start the &ldquo;extract correlations, import graph database&rdquo;, let&rsquo;s introduce the tools we will use.</p>
<p>&ldquo;Extracting relationships&rdquo; can be simply considered as Extract and Transform in ETL, which is essentially the engineering of data mapping and transformation, and there are many different tools and open-source projects available on the market. Here we use one of my personal favorite tools: dbt.</p>
<h3 id="dbt" class="headerLink">
    <a href="#dbt" class="header-mark"></a>5.1 dbt</h3><p>dbt is an open-source data conversion tool with a very mature community and ecology, which can perform efficient, controlled, and high-quality data conversion work in most of the mainstream data warehouses, whether it is for ad-hoc tasks or complex orchestration, dbt can be very competent.</p>
<p>One of the features of dbt is that it uses a SQL-like language to describe the rules of data transformation. With GitOps, it is very elegant to collaborate and maintain complex data processing operations in large data teams. And the built-in data testing capabilities allow you to control the quality of your data and make it reproducible and controllable.</p>
<p>dbt not only has many integrated subprojects but also can be combined with many other excellent open source projects (meltano, AirFlow, Amundsen, Superset, etc.) to form a set of modern data infrastructure systems, feel free to check my previous article: data lineage and metadata governance reference architecture <a href="https://siwei.io/en/data-lineage-oss-ref-solution" target="_blank" rel="noopener noreferrer">https://siwei.io/en/data-lineage-oss-ref-solution</a>, where the whole solution looks like:</p>
<p><figure><img
        
        loading="lazy"
        src="https://user-images.githubusercontent.com/1651790/168849779-4826f50e-ff87-4e78-b17f-076f91182c43.svg"
        srcset="https://user-images.githubusercontent.com/1651790/168849779-4826f50e-ff87-4e78-b17f-076f91182c43.svg, https://user-images.githubusercontent.com/1651790/168849779-4826f50e-ff87-4e78-b17f-076f91182c43.svg 1.5x, https://user-images.githubusercontent.com/1651790/168849779-4826f50e-ff87-4e78-b17f-076f91182c43.svg 2x"
        sizes="auto"
        alt="https://user-images.githubusercontent.com/1651790/168849779-4826f50e-ff87-4e78-b17f-076f91182c43.svg"
        title="https://user-images.githubusercontent.com/1651790/168849779-4826f50e-ff87-4e78-b17f-076f91182c43.svg" ></figure></p>
<p>In short, dbt is a command line tool written in python, and we can create a project folder, which contains a YAML formatted configuration file, to specify where the source information for the data transformation is and where the target is (where the processed data is stored, maybe Postgres, Big Query, Spark, etc.). In the data source, we use the YAML file along with the <code>.SQL</code> file to describe the information about &ldquo;what data to fetch from, how to do the transformation, and what to output&rdquo;.</p>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/starter-project-dbt-cli.webp"
        srcset="/nebulagraph-etl-dbt/starter-project-dbt-cli.webp, /nebulagraph-etl-dbt/starter-project-dbt-cli.webp 1.5x, /nebulagraph-etl-dbt/starter-project-dbt-cli.webp 2x"
        sizes="auto"
        alt="starter-project-dbt-cli"
        title="starter-project-dbt-cli" height="1760"   width="2950" ></figure></p>
<p>You can see that the information in the models/example is the core data transformation rules, and all the other data is metadata related to this transformation. DataOps.</p>
<blockquote>
<p>Notes.</p>
<p>You can refer to the dbt documentation to get a hands-on understanding of it: <a href="https://docs.getdbt.com/docs/get-started/getting-started-dbt-core" target="_blank" rel="noopener noreferrer">https://docs.getdbt.com/docs/get-started/getting-started-dbt-core</a></p>
</blockquote>
<h3 id="nebulagraph-data-ingestion" class="headerLink">
    <a href="#nebulagraph-data-ingestion" class="header-mark"></a>5.2 NebulaGraph data ingestion</h3><p>After processing the data by dbt, we can get intermediate data that maps directly to different types of vertices, edges, and table structures of their attributes, either in the form of CSV files, tables in DWs, or even data frames in Spark, and there are different options for importing them into NebulaGraph, of which NebulaGraph Exchange, Nebula-Importer, and Nebula-Spark-Connector can be used to import the data.</p>
<blockquote>
<p>Notes.</p>
<p>You can learn more about the different tools for NebulaGraph data import at <a href="https://siwei.io/en/sketches/nebula-data-import-options" target="_blank" rel="noopener noreferrer">https://siwei.io/en/sketches/nebula-data-import-options</a> to know how to choose one of them c.</p>
</blockquote>
<p>Here, I will use the simplest one, Nebula-Importer, as an example.</p>
<p>Nebula-Importer is an open-source tool written in Golang that compiles into a single file binary, it gets the correspondence of vertices and edges from a given CSV file to a NebulaGraph for reading and importing via a preconfigured YAML format file.</p>
<blockquote>
<p>Notes.</p>
<p>Nebula-Importer code: <a href="https://github.com/vesoft-inc/nebula-importer/" target="_blank" rel="noopener noreferrer">https://github.com/vesoft-inc/nebula-importer/</a></p>
<p>Nebula-Importer documentation: <a href="https://docs.nebula-graph.io/master/nebula-importer/use-importer/" target="_blank" rel="noopener noreferrer">https://docs.nebula-graph.io/master/nebula-importer/use-importer/</a></p>
</blockquote>
<h2 id="dbt--nebula-importer-in-actions" class="headerLink">
    <a href="#dbt--nebula-importer-in-actions" class="header-mark"></a>6 dbt + Nebula-Importer in Actions</h2><p>Now let&rsquo;s use dbt + Nebula-Importer to end-to-end demonstrate how to extract, transform and import multiple data sources into NebulaGraph, the whole project code has been open-sourced, the repository is at <a href="https://github.com/wey-gu/movie-recommendation-dataset" target="_blank" rel="noopener noreferrer">https://github.com/wey-gu/movie-recommendation-dataset</a>, feel free to check for details there.</p>
<p>The whole process is as follows.</p>
<ul>
<li>Preprocess and import raw data into the data warehouse(EL)</li>
<li>Use dbt to transform the data (Transform), and export it to CSV files</li>
<li>Import CSV into NebulaGraph using Nebula Importer (L)</li>
</ul>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/ETL_dbt_nebulagraph_importer.webp"
        srcset="/nebulagraph-etl-dbt/ETL_dbt_nebulagraph_importer.webp, /nebulagraph-etl-dbt/ETL_dbt_nebulagraph_importer.webp 1.5x, /nebulagraph-etl-dbt/ETL_dbt_nebulagraph_importer.webp 2x"
        sizes="auto"
        alt="ETL_dbt_nebulagraph_importer"
        title="ETL_dbt_nebulagraph_importer" height="1976"   width="2716" ></figure></p>
<h3 id="preparing-the-dbt-environment" class="headerLink">
    <a href="#preparing-the-dbt-environment" class="header-mark"></a>6.1 Preparing the dbt environment</h3><p>dbt is a python project, we install dbt and dbt-postgres in a virtual python3 environment.</p>
<h3 id="setup-env-with-dbt" class="headerLink">
    <a href="#setup-env-with-dbt" class="header-mark"></a>6.2 Setup env with dbt</h3><p>dbt is written in python, we could install it in a python virtual env, together with dbt-Postgres, as we will use Postgres as the DW in this sample project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python3 -m venv .venv
</span></span><span class="line"><span class="cl"><span class="nb">source</span> .venv/bin/activate
</span></span><span class="line"><span class="cl">pip install dbt-postgres
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a dbt project:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dbt init dbt_project
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> dbt_project
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s see the files in this project:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tree .
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- README.md                      <span class="c1"># README of the project</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- analyses
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- dbt_project.yml                <span class="c1"># dbt project conf</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- macros
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- models                         <span class="c1"># transforms</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="se">\-</span>- example
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- my_first_dbt_model.sql <span class="c1"># meta data to describe transform rules from the source data with SELECT</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- my_second_dbt_model.sql
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="se">\-</span>- schema.yml             <span class="c1"># the meta data of the rules</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- seeds                          <span class="c1"># for CSV-file data sources</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- snapshots
</span></span><span class="line"><span class="cl"><span class="se">\-</span>- tests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">7</span> directories, <span class="m">5</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, let&rsquo;s bootstrap a Postgress as the DW, if you already have one, you may skip this step, please ensure the configurations and dbt-plugins are aligned if you chose to use your own DW.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run --rm --name postgres <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -e <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>nebula <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -e <span class="nv">POSTGRES_USER</span><span class="o">=</span>nebula <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -e <span class="nv">POSTGRES_DB</span><span class="o">=</span>warehouse -d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -p 5432:5432 postgres
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="data-download-and-preprocess" class="headerLink">
    <a href="#data-download-and-preprocess" class="header-mark"></a>6.3 Data download and preprocess</h3><p>Let&rsquo;s create a folder named <code>raw_data</code> and change the directory to it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p raw_data
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> raw_data
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we assumed it was under our dbt project:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tree ..
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- README.md
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- analyses
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- dbt_project.yml
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- macros
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- models
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="se">\-</span>- example
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- my_first_dbt_model.sql
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- my_second_dbt_model.sql
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="se">\-</span>- schema.yml
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- raw_data                       <span class="c1"># &lt;--- newly created data</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- seeds
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- snapshots
</span></span><span class="line"><span class="cl"><span class="se">\-</span>- tests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">8</span> directories, <span class="m">5</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><p>Download and decompress the OMDB data:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget www.omdb.org/data/all_people.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/all_people_aliases.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/people_links.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/all_casts.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/job_names.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/all_characters.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/movie_categories.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/movie_keywords.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/category_names.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/all_categories.csv.bz2
</span></span><span class="line"><span class="cl">wget www.omdb.org/data/all_movie_aliases_iso.csv.bz2
</span></span><span class="line"><span class="cl">bunzip2 *.bz2
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then for the MovieLens dataset:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://files.grouplens.org/datasets/movielens/ml-latest-small.zip
</span></span><span class="line"><span class="cl">unzip ml-latest-small.zip
</span></span><span class="line"><span class="cl">rm *.zip
</span></span></code></pre></td></tr></table>
</div>
</div><p>Before we do the Transform with dbt, we do some simple preprocess and then put them under <code>seeds</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grep -v <span class="s1">&#39;\\&#34;&#39;</span> raw_data/all_movie_aliases_iso.csv &gt; seeds/all_movie_aliases_iso.csv
</span></span><span class="line"><span class="cl">grep -v <span class="s1">&#39;\\&#34;&#39;</span> raw_data/all_casts.csv &gt; seeds/all_casts.csv
</span></span><span class="line"><span class="cl">grep -v <span class="s1">&#39;\\&#34;&#39;</span> raw_data/all_characters.csv &gt; seeds/all_characters.csv
</span></span><span class="line"><span class="cl">grep -v <span class="s1">&#39;\\&#34;&#39;</span> raw_data/all_people.csv &gt; seeds/all_people.csv
</span></span><span class="line"><span class="cl">grep -v <span class="s1">&#39;\\&#34;&#39;</span> raw_data/category_names.csv &gt; seeds/category_names.csv
</span></span><span class="line"><span class="cl">grep -v <span class="s1">&#39;\\&#34;&#39;</span> raw_data/job_names.csv &gt; seeds/job_names.csv
</span></span><span class="line"><span class="cl">cp raw_data/movie_categories.csv seeds/movie_categories.csv
</span></span><span class="line"><span class="cl">cp raw_data/movie_keywords.csv seeds/movie_keywords.csv
</span></span><span class="line"><span class="cl">cp raw_data/all_categories.csv seeds/all_categories.csv
</span></span><span class="line"><span class="cl">cp raw_data/ml-latest-small/ratings.csv seeds/movielens_ratings.csv
</span></span><span class="line"><span class="cl">cp raw_data/ml-latest-small/movies.csv seeds/movielens_movies.csv
</span></span></code></pre></td></tr></table>
</div>
</div><p>With the above files being placed, we could load them into DW in one command:</p>
<blockquote>
<p>Refer to the documentation of dbt <code>seeds</code> <a href="https://docs.getdbt.com/docs/build/seeds" target="_blank" rel="noopener noreferrer">https://docs.getdbt.com/docs/build/seeds</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dbt seed
</span></span></code></pre></td></tr></table>
</div>
</div><p>It may take a while if you like me are using a local Postgres, and it should be faster in production-level cases (i.e. load to Big Query from the file in Cloud Storage), it should be like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ dbt seed
</span></span><span class="line"><span class="cl">05:58:27  Running with <span class="nv">dbt</span><span class="o">=</span>1.3.0
</span></span><span class="line"><span class="cl">05:58:27  Found <span class="m">2</span> models, <span class="m">4</span> tests, <span class="m">0</span> snapshots, <span class="m">0</span> analyses, <span class="m">289</span> macros, <span class="m">0</span> operations, <span class="m">11</span> seed files, <span class="m">0</span> sources, <span class="m">0</span> exposures, <span class="m">0</span> metrics
</span></span><span class="line"><span class="cl">05:58:28  
</span></span><span class="line"><span class="cl">05:58:28  Concurrency: <span class="m">8</span> threads <span class="o">(</span><span class="nv">target</span><span class="o">=</span><span class="s1">&#39;dev&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">05:58:28  
</span></span><span class="line"><span class="cl">05:58:28  <span class="m">1</span> of <span class="m">11</span> START seed file public.all_casts ....................................... <span class="o">[</span>RUN<span class="o">]</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">07:10:11  <span class="m">1</span> of <span class="m">11</span> OK loaded seed file public.all_casts ................................... <span class="o">[</span>INSERT <span class="m">1082228</span> in 4303.78s<span class="o">]</span>
</span></span><span class="line"><span class="cl">07:10:11  
</span></span><span class="line"><span class="cl">07:10:11  Finished running <span class="m">11</span> seeds in <span class="m">1</span> hours <span class="m">11</span> minutes and 43.93 seconds <span class="o">(</span>4303.93s<span class="o">)</span>.
</span></span><span class="line"><span class="cl">07:10:11  
</span></span><span class="line"><span class="cl">07:10:11  Completed successfully
</span></span><span class="line"><span class="cl">07:10:11  
</span></span><span class="line"><span class="cl">07:10:11  Done. <span class="nv">PASS</span><span class="o">=</span><span class="m">11</span> <span class="nv">WARN</span><span class="o">=</span><span class="m">0</span> <span class="nv">ERROR</span><span class="o">=</span><span class="m">0</span> <span class="nv">SKIP</span><span class="o">=</span><span class="m">0</span> <span class="nv">TOTAL</span><span class="o">=</span><span class="m">11</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="compose-the-transform-model" class="headerLink">
    <a href="#compose-the-transform-model" class="header-mark"></a>6.4 Compose the Transform model</h3><p>We create transform under <code>models</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir models/movie_recommedation
</span></span><span class="line"><span class="cl">touch models/movie_recommedation/user_watched_movies.sql
</span></span><span class="line"><span class="cl">touch models/movie_recommedation/schema.yml
</span></span></code></pre></td></tr></table>
</div>
</div><p>The files are like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tree models
</span></span><span class="line"><span class="cl">models
</span></span><span class="line"><span class="cl"><span class="se">\-</span>- movie_recommedation
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- user_watched_movies.sql
</span></span><span class="line"><span class="cl">    <span class="se">\-</span>- schema.yml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now there is only one transform rule under this model: to handle the edge of <code>user_watched_movies</code> in the <code>user_watched_movies.sql</code></p>
<p>As we planned to output three columns: user_id, movie_id, rating, thus the <code>schema.yml</code> is like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">models</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user_watched_movies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;The edges between users and movies they have watched&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">columns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;user id&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">not_null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">movie_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;movie id&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">not_null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rating</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rating given by user to movie&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">not_null</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Please be noted the <code>tests</code> are about the validation and constraint of the data, with which, we could control the data quality quite easily. And here <code>not_null</code> ensures there is no NULL if tests are performed.</p>
<p>Then, let&rsquo;s compose the <code>user_watched_movies.sql</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">{{</span><span class="w"> </span><span class="n">config</span><span class="p">(</span><span class="n">materialized</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">}}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> JOIN the movieielens_ratings table with the movieielens_movies table, and removing the movie title tailing the year of release
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WITH</span><span class="w"> </span><span class="n">user_watched_movies</span><span class="w"> </span><span class="k">AS</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">moveielens_ratings</span><span class="p">.</span><span class="s2">&#34;userId&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">moveielens_ratings</span><span class="p">.</span><span class="s2">&#34;movieId&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">moveielens_ratings</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">REGEXP_REPLACE</span><span class="p">(</span><span class="n">moveielens_movies</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; \(\d{4}\)$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">moveielens_movies</span><span class="p">.</span><span class="n">genres</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">movielens_genres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">moveielens_ratings</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="n">moveielens_movies</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">moveielens_movies</span><span class="p">.</span><span class="s2">&#34;movieId&#34;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveielens_ratings</span><span class="p">.</span><span class="s2">&#34;movieId&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm"> JOIN user_watched_movies table with all_movie_aliase_iso table where language is English
</span></span></span><span class="line"><span class="cl"><span class="cm"> the join condition is the movie title
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;u_&#39;</span><span class="p">,</span><span class="n">user_watched_movies</span><span class="p">.</span><span class="s2">&#34;userId&#34;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_watched_movies</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_watched_movies</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">all_movie_aliases_iso</span><span class="p">.</span><span class="s2">&#34;movie_id&#34;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">OMDB_movie_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_watched_movies</span><span class="p">.</span><span class="n">movielens_genres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">user_watched_movies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">all_movie_aliases_iso</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_watched_movies</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">all_movie_aliases_iso</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">all_movie_aliases_iso</span><span class="p">.</span><span class="n">language_iso_639_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;en&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And what this SQL does is the part marked by the green circle:</p>
<ul>
<li>Select the user id, movie id, rating, and movie title (remove the year part) from <code>moveielens_ratings</code> and save it as the intermediate table of <code>user_watched_movies</code>
<ul>
<li>movie title is <code>JOIN</code>ed from <code>moveielens_movies</code>, obtained by the same matching condition as <code>movie_id</code></li>
</ul>
</li>
<li>Select user id (prefix <code>u_</code>), rating, title, OMDB_movie_id from <code>user_watched_movies</code>
<ul>
<li>OMDB_movie_id is <code>JOIN</code>ed from <code>all_movie_aliases_iso</code>, obtained by matching the Chinese and English titles of OMDB movies with similar movie names</li>
<li>output the final fields</li>
</ul>
</li>
</ul>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/transform_select_joins_user_watched_movies.webp"
        srcset="/nebulagraph-etl-dbt/transform_select_joins_user_watched_movies.webp, /nebulagraph-etl-dbt/transform_select_joins_user_watched_movies.webp 1.5x, /nebulagraph-etl-dbt/transform_select_joins_user_watched_movies.webp 2x"
        sizes="auto"
        alt="transform_select_joins_user_watched_movies"
        title="transform_select_joins_user_watched_movies" height="1806"   width="1808" ></figure></p>
<blockquote>
<p>Tips: we could add <code>LIMIT</code> to debug the SQL query fast from a Postgres Console</p>
</blockquote>
<p>Then we could run it from dbt to transform and test the rule:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dbt run -m user_watched_movies
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, we should be able to see a table after the Transform in Postgres (DW).</p>
<p>Similarly, following the same method for all other parts of the Transform rules, we could have other models:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tree models
</span></span><span class="line"><span class="cl">models
</span></span><span class="line"><span class="cl"><span class="se">\-</span>- movie_recommedation
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- acted_by.sql
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- directed_by.sql
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- genres.sql
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- movies.sql
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- people.sql
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- schema.yml
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- user_watched_movies.sql
</span></span><span class="line"><span class="cl">    <span class="se">\-</span>- with_genre.sql
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then run them all:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dbt run -m acted_by
</span></span><span class="line"><span class="cl">dbt run -m directed_by
</span></span><span class="line"><span class="cl">dbt run -m with_genre
</span></span><span class="line"><span class="cl">dbt run -m people
</span></span><span class="line"><span class="cl">dbt run -m genres
</span></span><span class="line"><span class="cl">dbt run -m movies
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="export-data-to-csv" class="headerLink">
    <a href="#export-data-to-csv" class="header-mark"></a>6.5 Export data to CSV</h3><p>NebulaGraph Exchange itself supports directly importing many data sources (Postgres, Clickhouse, MySQL, Hive, etc.) into NebulaGraph, but in this example, the amount of data we process is very small for NebulaGraph, so we just go with the most lightweight one: Nebula-Importer. Nebula-Importer can only CSV files, so we are doing so.</p>
<p>First, we enter the Postgres console and execute the <code>COPY</code> command</p>
<blockquote>
<p>Refer to Postgres documentation: <a href="https://www.postgresql.org/docs/current/sql-copy.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/sql-copy.html</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">COPY</span><span class="w"> </span><span class="n">acted_by</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/acted_by.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COPY</span><span class="w"> </span><span class="n">directed_by</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/directed_by.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COPY</span><span class="w"> </span><span class="n">with_genre</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/with_genre.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COPY</span><span class="w"> </span><span class="n">people</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/people.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COPY</span><span class="w"> </span><span class="n">movies</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/movies.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COPY</span><span class="w"> </span><span class="n">genres</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/genres.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- for user_watched_movies, we don&#39;t output HEADER, as we will parse it in importer in a no-header way.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">COPY</span><span class="w"> </span><span class="n">user_watched_movies</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;/tmp/user_watched_movies.csv&#39;</span><span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then copy the CSV files into <code>to_nebulagraph</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p to_nebulagraph
</span></span><span class="line"><span class="cl">docker cp postgres:/tmp/. to_nebulagraph/
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ingest-data-into-nebulagraph" class="headerLink">
    <a href="#ingest-data-into-nebulagraph" class="header-mark"></a>6.6 Ingest data into NebulaGraph</h3><h4 id="bootstrap-a-nebulagraph-cluster" class="headerLink">
    <a href="#bootstrap-a-nebulagraph-cluster" class="header-mark"></a>6.6.1 Bootstrap a NebulaGraph cluster</h4><p>We can use Nebula-Up to have a NebulaGraph playground cluster with the oneliner.</p>
<blockquote>
<p>Note:</p>
<ul>
<li>
<p>Nebula-UP: <a href="https://github.com/wey-gu/nebula-up" target="_blank" rel="noopener noreferrer">https://github.com/wey-gu/nebula-up</a></p>
</li>
<li>
<p>Dataset repository: <a href="https://github.com/wey-gu/movie-recommendation-dataset" target="_blank" rel="noopener noreferrer">https://github.com/wey-gu/movie-recommendation-dataset</a></p>
</li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -fsSL nebula-up.siwei.io/install.sh <span class="p">|</span> bash
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="define-the-data-schema" class="headerLink">
    <a href="#define-the-data-schema" class="header-mark"></a>6.6.2 Define the Data Schema</h4><p>First, we need to create a graph space, and then create tag(type of vertex) and edge type on it:</p>
<p>Access the Nebula-Console(CLI client for NebulaGraph):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~/.nebula-up/console.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Run the following DDL(Data Definition Language):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">SPACE</span><span class="w"> </span><span class="n">moviegraph</span><span class="p">(</span><span class="n">partition_num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">replica_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">vid_type</span><span class="o">=</span><span class="n">fixed_string</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">:</span><span class="n">sleep</span><span class="w"> </span><span class="mi">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">USE</span><span class="w"> </span><span class="n">moviegraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="n">person</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">birthdate</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="n">movie</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="n">genre</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="n">user_id</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EDGE</span><span class="w"> </span><span class="n">acted_by</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EDGE</span><span class="w"> </span><span class="n">directed_by</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EDGE</span><span class="w"> </span><span class="n">with_genre</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EDGE</span><span class="w"> </span><span class="n">watched</span><span class="p">(</span><span class="n">rate</span><span class="w"> </span><span class="nb">float</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">exit</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="create-a-nebula-importer-conf-file" class="headerLink">
    <a href="#create-a-nebula-importer-conf-file" class="header-mark"></a>6.6.3 Create a Nebula-Importer conf file</h4><p>This conf is a YAML file that describes the correspondence between the CSV file and the vertex or edge data in the cluster.</p>
<p>Please refer to the document: <a href="https://docs.nebula-graph.io/master/nebula-importer/use-importer/" target="_blank" rel="noopener noreferrer">https://docs.nebula-graph.io/master/nebula-importer/use-importer/</a> for details.</p>
<p>I already created one for it, which can be downloaded at <a href="https://github.com/wey-gu/movie-recommendation-dataset/blob/main/nebula-importer.yaml" target="_blank" rel="noopener noreferrer">https://github.com/wey-gu/movie-recommendation-dataset/blob/main/nebula-importer.yaml</a>.</p>
<p>Here, we will directly download the configuration file.</p>
<blockquote>
<p>Note that this file should not be part of the dbt project file.:</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span><span class="line"><span class="cl">wget https://raw.githubusercontent.com/wey-gu/movie-recommendation-dataset/main/nebula-importer.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ingesting-the-data" class="headerLink">
    <a href="#ingesting-the-data" class="header-mark"></a>6.6.4 Ingesting the data</h4><p>Let&rsquo;s use the Nebula-Importer in docker to avoid any installation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run --rm -ti <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --network<span class="o">=</span>nebula-net <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>:/root/ <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/dbt_project/to_nebulagraph/:/data <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    vesoft/nebula-importer:v3.2.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --config /root/nebula-importer.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>After it&rsquo;s executed, all data are in NebulaGraph, and we could check the data from Nebula-Console:</p>
<p>First, access the console again:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~/.nebula-up/console.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Enter the graph space and execute <code>SHOW STATS</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">USE</span><span class="w"> </span><span class="n">moviegraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SHOW</span><span class="w"> </span><span class="n">STATS</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The result should be like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="p">(</span><span class="n">root</span><span class="o">@</span><span class="n">nebula</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">moviegraph</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="n">STATS</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------+---------------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Name</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">Count</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------+---------------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Tag&#34;</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;genre&#34;</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">14397</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Tag&#34;</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;movie&#34;</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">20701</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Tag&#34;</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;person&#34;</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">263907</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Tag&#34;</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="mi">610</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Edge&#34;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;acted_by&#34;</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">673763</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Edge&#34;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;directed_by&#34;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">101949</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Edge&#34;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;watched&#34;</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">31781</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Edge&#34;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;with_genre&#34;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">194009</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Space&#34;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;vertices&#34;</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">299615</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;Space&#34;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;edges&#34;</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">1001502</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------+---------------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Got</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="n">spent</span><span class="w"> </span><span class="mi">1693</span><span class="o">/</span><span class="mi">15136</span><span class="w"> </span><span class="n">us</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>With Nebula-Studio, we can also explore this graph in the visual interface, for example, by executing this query, we could see the reason why it recommended the movie with id 1891 to the user with id u_124.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="n">FIND</span><span class="w"> </span><span class="n">NOLOOP</span><span class="w"> </span><span class="n">PATH</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s2">&#34;u_124&#34;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s2">&#34;1891&#34;</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BIDIRECT</span><span class="w"> </span><span class="n">UPTO</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="n">yield</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">p</span><span class="o">`</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">20</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The result could be: Most of the cast and crew of the once-favorite Star Wars movies are also involved in this and the same &ldquo;Oscar-winning&rdquo; and &ldquo;classic&rdquo; movie.</p>
<p><figure><img
        
        loading="lazy"
        src="/nebulagraph-etl-dbt/reasoning_movie.webp"
        srcset="/nebulagraph-etl-dbt/reasoning_movie.webp, /nebulagraph-etl-dbt/reasoning_movie.webp 1.5x, /nebulagraph-etl-dbt/reasoning_movie.webp 2x"
        sizes="auto"
        alt="reasoning_movie"
        title="reasoning_movie" height="1110"   width="2276" ></figure></p>
<blockquote>
<p>In another article, I used the same graph to demonstrate the application of more graph databases and graph algorithms in recommendation systems. If you are interested, please read <a href="https://siwei.io/recommendation-system-with-graphdb/" target="_blank" rel="noopener noreferrer">https://siwei.io/recommendation-system-with-graphdb/</a>.</p>
</blockquote>
<h2 id="summary" class="headerLink">
    <a href="#summary" class="header-mark"></a>7 Summary</h2><p>When we plan to leverage graph databases for massive data to transform knowledge and analyze insights, the first step is often to transform, process, and model multiple data sources into graph data. For beginners who have no idea where to start, a feasible idea is to start from all relevant information, picture the most concerning relationship, and then list the vertices that can be obtained and the required properties attached. After determining the initial modeling, you can use the ETL tool to clean the original data, ETL into table structure which will be mapped to the graph, and finally, use the import tool to import NebulaGraph for further model iterations.</p>
<p>With the help of dbt, we can version control, test, iterate our modeling and data transformation, and gradually evolve and enrich the constructed knowledge graph with grace.</p>
<blockquote>
<p>Feature image credit: <a href="https://unsplash.com/photos/Bu4lHKIHr-E" target="_blank" rel="noopener noreferrer">Claudio</a></p>
</blockquote></div>

        


<h2>Related Content</h2>
<div class="related-container">
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/en/demos/graph-rag/">Deme: Graph RAG, the new LLM Stack</a>
            </h2>
        </div>
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/en/demos/text2cypher/">Deme: Build Knowledge Graph and Text2Cypher in NebulaGraph</a>
            </h2>
        </div>
    <div class="related-item-container">
            <div class="related-image">
                <a href="/en/llm-text-to-nebulagraph-query/"><img
        
        loading="lazy"
        src="/llm-text-to-nebulagraph-query/featured-image.webp"
        srcset="/llm-text-to-nebulagraph-query/featured-image.webp, /llm-text-to-nebulagraph-query/featured-image.webp 1.5x, /llm-text-to-nebulagraph-query/featured-image.webp 2x"
        sizes="auto"
        alt="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt."
        title="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt." height="200"   width="400" ></a>
            </div><h2 class="related-title">
                <a href="/en/llm-text-to-nebulagraph-query/">Text2Cypher, the beginning of the Graph &#43; LLM stack</a>
            </h2>
        </div>
    <div class="related-item-container">
            <div class="related-image">
                <a href="/en/nebulagraph-in-jupyter-notebook/"><img
        
        loading="lazy"
        src="/nebulagraph-in-jupyter-notebook/featured-image.webp"
        srcset="/nebulagraph-in-jupyter-notebook/featured-image.webp, /nebulagraph-in-jupyter-notebook/featured-image.webp 1.5x, /nebulagraph-in-jupyter-notebook/featured-image.webp 2x"
        sizes="auto"
        alt="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt."
        title="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt." height="200"   width="400" ></a>
            </div><h2 class="related-title">
                <a href="/en/nebulagraph-in-jupyter-notebook/">NebulaGraph in Jupyter Notebook</a>
            </h2>
        </div>
    <div class="related-item-container">
            <div class="related-image">
                <a href="/en/graph-enabled-llama-index/"><img
        
        loading="lazy"
        src="/graph-enabled-llama-index/featured-image.webp"
        srcset="/graph-enabled-llama-index/featured-image.webp, /graph-enabled-llama-index/featured-image.webp 1.5x, /graph-enabled-llama-index/featured-image.webp 2x"
        sizes="auto"
        alt="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt."
        title="How could we model data in Tabular sources and ETL it to NebulaGraph? This article demonstrates an end-to-end example of doing so with dbt." height="200"   width="400" ></a>
            </div><h2 class="related-title">
                <a href="/en/graph-enabled-llama-index/">Graph Enabled Llama Index</a>
            </h2>
        </div>
    

</div>

<div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-04-28&nbsp;<a class="git-hash" href="github.com/siwei-io/siwei-io.github.io/commit/e91026f0080f5d568af463216d70f7b17b48ebe7" target="_blank" title="commit by Wey Gu(weyl.gu@gmail.com) e91026f0080f5d568af463216d70f7b17b48ebe7: bugfix: fixed wrong cypher query" rel="noopener noreferrer">
                                    <i class="fas fa-hashtag fa-fw"></i>e91026f</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/en/nebulagraph-etl-dbt/index.md target="_blank" rel="noopener noreferrer">Read markdown</a>
                    </span><span>|&nbsp;<a class="link-to-report" href=https://github.com/siwei-io/siwei-io.github.io/issues/new?title=[bug]%20Tabular+Data+ETL+to+NebulaGraph+with+dbt&body=|Field|Value|%0A|-|-|%0A|Title|Tabular+Data+ETL+to+NebulaGraph+with+dbt|%0A|Url|https://siwei.io/en/nebulagraph-etl-dbt/|%0A|Filename|posts/nebulagraph-etl-dbt/index.en.md| target="_blank" rel="noopener noreferrer">Report issue</a>
                    </span></div>
            <div class="post-info-share"><button title="Share on Twitter" data-sharer="twitter" data-url="https://siwei.io/en/nebulagraph-etl-dbt/" data-title="Tabular Data ETL to NebulaGraph with dbt" data-via="wey_gu" data-hashtags="Nebula Graph,etl,dbt,Graph Modeling,MovieLens,OMDB"><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Facebook" data-sharer="facebook" data-url="https://siwei.io/en/nebulagraph-etl-dbt/" data-hashtag="Nebula Graph"><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Hacker News" data-sharer="hackernews" data-url="https://siwei.io/en/nebulagraph-etl-dbt/" data-title="Tabular Data ETL to NebulaGraph with dbt"><span class="fab fa-hacker-news fa-fw"></span></button><button title="Share on Line" data-sharer="line" data-url="https://siwei.io/en/nebulagraph-etl-dbt/" data-title="Tabular Data ETL to NebulaGraph with dbt"><span data-svg-src="/lib/simple-icons/icons/line.min.svg"></span></button><button title="Share on 微博" data-sharer="weibo" data-url="https://siwei.io/en/nebulagraph-etl-dbt/" data-title="Tabular Data ETL to NebulaGraph with dbt" data-image="featured-image.webp" data-ralateuid="siweigu"><span class="fab fa-weibo fa-fw"></span></button><button title="Share on Telegram" data-sharer="telegram" data-url="https://siwei.io/en/nebulagraph-etl-dbt/" data-title="Tabular Data ETL to NebulaGraph with dbt" data-web><span class="fab fa-telegram-plane fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/en/tags/nebula-graph/">Nebula Graph</a>,&nbsp;<a href="/en/tags/etl/">Etl</a>,&nbsp;<a href="/en/tags/dbt/">Dbt</a>,&nbsp;<a href="/en/tags/graph-modeling/">Graph Modeling</a>,&nbsp;<a href="/en/tags/movielens/">MovieLens</a>,&nbsp;<a href="/en/tags/omdb/">OMDB</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/en/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/en/fraud-detection-with-nebulagraph/" class="prev" rel="prev" title="Fraud Detection with NebulaGraph GraphDatabase in action"><i class="fas fa-angle-left fa-fw"></i>Fraud Detection with NebulaGraph GraphDatabase in action</a>
            <a href="/en/chatgpt-and-nebulagraph-predict-fifa-world-cup/" class="next" rel="next" title="Use ChatGPT and Nebulagraph to Predict Fifa World Cup">Use ChatGPT and Nebulagraph to Predict Fifa World Cup<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.125.6">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2018 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://siwei.io" target="_blank" rel="noopener noreferrer">Wey Gu</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div><script>
                    if('serviceWorker' in navigator) {
                        navigator.serviceWorker
                            .register('/sw.min.js', { scope: '/' })
                            .then(function(registration) {
                            });
                
                        navigator.serviceWorker
                            .ready
                            .then(function(registration) {
                            });
                    }
                </script></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"giscus":{"darkTheme":"dark","dataCategory":"Comments","dataCategoryId":"DIC_kwDOFhiy8c4CQeuu","dataEmitMetadata":"1","dataInputPosition":"bottom","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"siwei-io/siwei-io.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkzNzA3MTc0MjU=","dataStrict":"1","lightTheme":"light"}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/en/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":true,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":300,"threshold":0.1,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript" src="/js/giscus.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-DYTTVYCRS2', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-DYTTVYCRS2" async></script></div>
</body>

</html>
